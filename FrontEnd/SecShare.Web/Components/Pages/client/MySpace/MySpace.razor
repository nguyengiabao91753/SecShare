@page "/myspace"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Forms

<!-- ===============================
HEADER SECTION
=============================== -->
<div class="content-header py-3 bg-white shadow-sm sticky-top border-bottom">
    <div class="container-fluid d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-3">
            <button class="btn btn-primary btn-lg rounded-circle shadow-sm upload-btn" @onclick="ToggleModal" title="Upload new file">
                <i class="fas fa-plus"></i>
            </button>
            <div>
                <h3 class="mb-0 fw-bold text-primary">My Files</h3>
                <small class="text-muted">Manage your documents securely</small>
            </div>
        </div>
        <ol class="breadcrumb mb-0 small text-muted" style="font-size: 1rem !important;">
            <li class="breadcrumb-item"><a href="/myspace">Home</a></li>
            <li class="breadcrumb-item active">My Space</li>
        </ol>
    </div>
</div>

<!-- ===============================
MAIN CONTENT
=============================== -->
<div class="container-fluid mt-4">

    <!-- FILTER SECTION -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3 align-items-center">
                <div class="col-md-9">
                    <div class="input-group search-bar">
                        <span class="input-group-text bg-transparent border-0">
                            <i class="fas fa-search text-secondary"></i>
                        </span>
                        <input type="text" class="form-control border-0" placeholder="Search by file name..." />
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select rounded-3">
                        <option>Sort by Name</option>
                        <option>Last Modified</option>
                        <option>File Size</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- FILE LIST -->
    <div class="card border-0 shadow-sm">
        <div class="table">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light text-secondary small">
                    <tr>
                        <th><i class="fas fa-file me-2"></i>Name</th>
                        <th><i class="fas fa-tag me-2"></i>Type</th>
                        <th><i class="fas fa-clock me-2"></i>Last Modified</th>
                        <th><i class="fas fa-hdd me-2"></i>Size</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (listFiles != null && listFiles.Any())
                    {
                        @foreach (var file in listFiles)
                        {
                            <tr class="file-row">
                                <td><i class="fas fa-file-alt text-primary me-2"></i>@file.FileName</td>
                                <td>@file.FileType</td>
                                <td>@file.UpdatedAt</td>
                                <td>@GetReadableSize(file.FileSize)</td>
                                <td class="text-end">
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary" title="Preview" @onclick="() => OpenSidebar(file)">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-success" title="Download">
                                            <i class="fas fa-download"></i>
                                        </button>
                                        <button class="btn btn-sm btn-light dropdown-toggle" data-bs-toggle="dropdown">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li><a class="dropdown-item" @onclick="() => OpenSidebar(file)"><i class="fas fa-info-circle me-2"></i>Details</a></li>
                                            <li><a class="dropdown-item" ><i class="fas fa-share me-2"></i>Share</a></li>
                                            <li><a class="dropdown-item" ><i class="fas fa-edit me-2"></i>Rename</a></li>
                                            <li><hr class="dropdown-divider" /></li>
                                            <li><a class="dropdown-item text-danger" ><i class="fas fa-trash me-2"></i>Delete</a></li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="5" class="text-center text-muted py-4">
                                <i class="fas fa-folder-open fa-2x mb-2"></i><br />
                                No files found
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ===============================
UPLOAD MODAL
=============================== -->
@if (isModalOpen)
{
    @* <div class="modal-backdrop fade show"></div> *@
    <div class="modal fade show d-block" tabindex="-1" style="z-index: 1055;">
        <div class="modal-dialog modal-lg modal-dialog-centered animate__animated animate__fadeInDown">
            <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden glassy-modal">

                <!-- Header -->
                <div class="modal-header border-0 bg-gradient text-white py-3 px-4" style="background-color: #007bff;">
                    <h5 class="modal-title fw-semibold">
                        <i class="fas fa-cloud-upload-alt me-2"></i> Upload your file
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseModal"></button>
                </div>

                <!-- Body -->
                <EditForm EditContext="editContext" OnValidSubmit="UploadFile">
                    <div class="modal-body bg-light-subtle p-4">

                        <!-- Dropzone -->
                        <div class="dropzone-modern mb-4 text-center p-5">
                            <i class="fas fa-upload fa-3x text-primary mb-3 drop-icon"></i>
                            <p class="text-muted mb-3 fs-6">Click below or drag your file here</p>
                            <InputFile OnChange="OnFileSelected"
                                       accept=".doc,.docx,.pdf,.txt,.jpg,.png"
                                       class="form-control border-0 shadow-none mx-auto upload-input" />
                        </div>

                        @if (isUpload)
                        {
                            <div class="card shadow-sm border-0 rounded-4 bg-white animate__animated animate__fadeIn">
                                <div class="card-body">
                                    <h6 class="fw-semibold mb-3 text-success">
                                        <i class="fas fa-check-circle me-2"></i>File ready to upload
                                    </h6>
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label small text-muted">File Name</label>
                                            <InputText class="@($"form-control rounded-pill {GetFileNameValidationClass()}")"
                                                       @bind-Value="uploadMyFileDto.FileName"
                                                       placeholder="Enter file name" />
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small text-muted">Type</label>
                                            <div class="form-control-plaintext">@("." + uploadMyFileDto.Type)</div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small text-muted">Size</label>
                                            <div class="form-control-plaintext">@GetReadableSize(uploadMyFileDto.FileSize)</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Footer -->
                    <div class="modal-footer border-0 bg-white rounded-bottom-4 py-3">
                        <button type="button" class="btn btn-outline-secondary rounded-pill px-4 shadow-sm"
                                @onclick="CloseModal">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary rounded-pill px-4 shadow-sm"
                                disabled="@(!isUpload)">
                            <i class="fas fa-upload me-2"></i> Upload
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
    <!-- backdrop chỉ hiển thị khi modal mở -->
    <div class="custom-backdrop"></div>
}

<!-- ===============================
SIDEBAR DETAIL
=============================== -->
<div class="sidebar-detail @(isSidebarOpen ? "open" : "") shadow-lg bg-white border-start">
    <div class="sidebar-header p-3 border-bottom bg-light d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-semibold text-primary"><i class="fas fa-info-circle me-2"></i>File Details</h5>
        <button class="btn btn-sm btn-outline-light text-muted" @onclick="CloseSidebar"><i class="fas fa-times"></i></button>
    </div>

    <div class="sidebar-body p-3">
        @if (selectedFile != null)
        {
            <ul class="nav nav-tabs" id="sidebarTabs" role="tablist">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabDetails" type="button">Details</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabShares" type="button">Shares</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabActivities" type="button">Activities</button></li>
            </ul>

            <div class="tab-content mt-3">
                <div class="card shadow-sm border-0 rounded-3 tab-pane fade show active" id="tabDetails" style="max-width: 420px;">
                    <div class="card-body">
                        <h5 class="card-cus text-primary mb-3">
                            <i class="fas fa-file-alt me-2"></i>File Details
                        </h5>

                        <div class="mb-2">
                            <p class="mb-1 text-muted small">Name</p>
                            <p class="fw-semibold text-dark">@selectedFile.FileName</p>
                        </div>

                        <div class="mb-2">
                            <p class="mb-1 text-muted small">Type</p>
                            <p class="fw-semibold">@selectedFile.FileType</p>
                        </div>

                        <div class="mb-2">
                            <p class="mb-1 text-muted small">Size</p>
                            <p class="fw-semibold">@GetReadableSize(selectedFile.FileSize)</p>
                        </div>

                        <div class="mb-4">
                            <p class="mb-1 text-muted small">Last Modified</p>
                            <p class="fw-semibold">@selectedFile.UpdatedAt.ToString("MMM dd, yyyy hh:mm tt")</p>
                        </div>

                        <div class="d-flex justify-content-end">
                            <button class="btn btn-outline-primary px-3" @onclick="() => ViewFileAsync(selectedFile.Id.ToString())">
                                <i class="fas fa-eye me-1"></i> View File
                            </button>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="tabShares">
                    <EditForm EditContext="editContextShare" OnValidSubmit="ShareFile" FormName="ShareForm">
                        <DataAnnotationsValidator />
                        <ValidationSummary class="alert text-left text-white" />
                        <InputText id="receiverEmail" @bind-Value="shareFileDto!.ReceiverEmail" DisplayName="Receiver Email" class="form-control" />
                        <ul class="list-group small pt-3">
                            @foreach (var u in listUsers)
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>

                                        <p><i class="fas fa-user-circle me-2"></i>@u.Email</p>

                                        <small class="d-block text-muted">Not downloaded</small>
                                    </div>
                                    

                                    @* <button class="btn btn-sm btn-outline-info"><i class="fas fa-info-circle"></i></button> *@
                                </li>
                            }
                            </ul>
                            <br />
                            <button type="submit" class="btn btn-primary w-100 py-2" disabled="@isShare">Share</button>
                        </EditForm>
                    </div>
                    <div class="tab-pane fade" id="tabActivities">
                        <p class="text-muted">Recent activities will appear here...</p>
                    </div>
                </div>
                            }
            else
            {
            <div class="text-center text-muted mt-5">
                <i class="fas fa-info-circle fa-2x mb-3"></i>
                <p>No file selected</p>
            </div>
            }
        </div>
    </div>



            @code {
                // Helper cho validation class (thêm vào code behind nếu cần EditContext đầy đủ)
    public string GetFileNameValidationClass()
            {
                return editContext?.IsModified() == true && string.IsNullOrWhiteSpace(uploadMyFileDto.FileName) ? "is-invalid" : "";
            }

            private void HandleInvalidSubmit()
            {
                // Tùy chọn: Show tổng hợp errors
                _notificationService.ShowError("Vui lòng sửa lỗi form trước khi upload!");
            }
}